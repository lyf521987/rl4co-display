# 实时训练曲线功能说明

## 功能概述

在TSP问题训练过程中，系统会**实时生成并更新**训练曲线图，展示每个epoch的Loss和Reward变化趋势。

## 核心特性

### 1. 自动记录训练指标
- 每完成一个epoch，自动记录该epoch的平均Loss和Reward
- 维护完整的历史数据，用于绘制累积曲线

### 2. 实时生成折线图
每个epoch结束时，系统会生成包含两个子图的折线图：

#### Loss曲线（上半部分）
- **蓝色折线**：显示每个epoch的Loss值变化
- **网格背景**：便于读取数值
- **标记点**：每个epoch用圆点标注

#### Reward曲线（下半部分）
- **绿色折线**：显示每个epoch的Reward值变化
- **红色虚线**：标注历史最佳Reward
- **红色星标**：突出显示达到最佳Reward的epoch

### 3. 通过SSE实时推送
训练曲线图会通过Server-Sent Events (SSE)推送给前端，包含：
- 图片URL路径
- 更新通知消息

## 后端实现

### ProgressCallback修改

```python
class ProgressCallback(Callback):
    def __init__(self, queue, session_id, total_epochs):
        super().__init__()
        self.queue = queue
        self.session_id = session_id
        self.total_epochs = total_epochs
        self.best_reward = float('-inf')
        self.epoch_losses = []
        self.epoch_rewards = []
        # 新增：历史数据存储
        self.history_losses = []
        self.history_rewards = []
        self.history_epochs = []
    
    def on_train_epoch_end(self, trainer, pl_module):
        epoch = trainer.current_epoch + 1
        
        # ... 获取loss和reward的代码 ...
        
        # 记录历史数据
        self.history_epochs.append(epoch)
        self.history_losses.append(loss)
        self.history_rewards.append(reward)
        
        # 生成实时训练曲线图
        plot_filename = f"training_curves_{self.session_id[:8]}.png"
        plot_path = os.path.join(PLOTS_DIR, plot_filename)
        
        # 创建双子图
        fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(10, 8))
        
        # 绘制Loss曲线
        ax1.plot(self.history_epochs, self.history_losses, 
                'b-o', linewidth=2, markersize=6, label='Loss')
        ax1.set_xlabel('Epoch', fontsize=12)
        ax1.set_ylabel('Loss', fontsize=12)
        ax1.set_title('训练Loss变化曲线', fontsize=14, fontweight='bold')
        ax1.grid(True, alpha=0.3, linestyle='--')
        ax1.legend(loc='upper right', fontsize=10)
        
        # 绘制Reward曲线
        ax2.plot(self.history_epochs, self.history_rewards, 
                'g-o', linewidth=2, markersize=6, label='Reward')
        ax2.set_xlabel('Epoch', fontsize=12)
        ax2.set_ylabel('Reward', fontsize=12)
        ax2.set_title('训练Reward变化曲线', fontsize=14, fontweight='bold')
        ax2.grid(True, alpha=0.3, linestyle='--')
        
        # 标注最佳reward
        best_epoch_idx = self.history_rewards.index(max(self.history_rewards))
        best_epoch_num = self.history_epochs[best_epoch_idx]
        ax2.axhline(y=self.best_reward, color='r', 
                   linestyle='--', alpha=0.5, label=f'Best: {self.best_reward:.4f}')
        ax2.scatter([best_epoch_num], [self.best_reward], 
                   color='red', s=100, zorder=5, marker='*')
        ax2.legend(loc='lower right', fontsize=10)
        
        plt.tight_layout()
        plt.savefig(plot_path, dpi=150, bbox_inches="tight")
        plt.close(fig)
        
        # 通过队列发送图表路径
        self.queue.put(json.dumps({
            'type': 'plot',
            'plot_url': f"/static/model_plots/{plot_filename}",
            'message': f'Epoch {epoch} 训练曲线已更新'
        }))
```

## 前端接收示例

### JavaScript SSE监听

```javascript
const eventSource = new EventSource(`/api/training_progress/${sessionId}`);

eventSource.addEventListener('message', function(event) {
    const data = JSON.parse(event.data);
    
    switch(data.type) {
        case 'plot':
            // 更新训练曲线图
            updateTrainingCurve(data.plot_url, data.message);
            break;
        
        case 'progress':
            // 更新进度信息
            updateProgress(data.epoch, data.loss, data.reward);
            break;
        
        case 'complete':
            // 训练完成，显示最终曲线
            if (data.results.training_curve) {
                showFinalTrainingCurve(data.results.training_curve);
            }
            break;
    }
});
```

### HTML显示容器

```html
<div class="training-visualization">
    <div class="training-curves">
        <h3>训练曲线（实时更新）</h3>
        <img id="trainingCurveImg" 
             src="" 
             alt="训练曲线" 
             style="width: 100%; max-width: 800px;">
        <p id="curveUpdateInfo" class="update-info"></p>
    </div>
</div>
```

### 更新函数

```javascript
function updateTrainingCurve(plotUrl, message) {
    const img = document.getElementById('trainingCurveImg');
    const info = document.getElementById('curveUpdateInfo');
    
    // 添加时间戳防止缓存
    img.src = plotUrl + '?t=' + new Date().getTime();
    info.textContent = message;
    
    // 可选：添加淡入效果
    img.style.opacity = '0.5';
    setTimeout(() => {
        img.style.opacity = '1';
    }, 100);
}
```

## 消息类型说明

### 新增：plot消息
```json
{
    "type": "plot",
    "plot_url": "/static/model_plots/training_curves_a1b2c3d4.png",
    "message": "Epoch 5 训练曲线已更新"
}
```

### 更新：training_status
在训练状态中新增了`plot_url`字段：
```json
{
    "progress": 50.0,
    "epoch": 5,
    "loss": 8.2341,
    "reward": -12.5678,
    "best_reward": -10.1234,
    "plot_url": "/static/model_plots/training_curves_a1b2c3d4.png"
}
```

### 更新：complete消息
最终结果中新增了`training_curve`字段：
```json
{
    "type": "complete",
    "message": "训练完成！",
    "results": {
        "model": "attention",
        "problem": "tsp",
        "strategy": "REINFORCE",
        "total_epochs": 10,
        "final_loss": 7.5432,
        "final_reward": -11.2345,
        "best_reward": -10.1234,
        "plot_paths": [...],
        "animation_paths": [...],
        "training_curve": "/static/model_plots/training_curves_a1b2c3d4.png",
        "checkpoint_path": "checkpoints/tsp-attention.ckpt"
    }
}
```

## 文件命名规则

训练曲线图文件命名格式：
```
training_curves_{session_id前8位}.png
```

例如：
- Session ID: `a1b2c3d4-e5f6-7890-1234-567890abcdef`
- 文件名: `training_curves_a1b2c3d4.png`
- 完整路径: `static/model_plots/training_curves_a1b2c3d4.png`

## 使用场景

### 1. 监控训练收敛情况
- 观察Loss是否持续下降
- 检查是否出现过拟合
- 判断是否需要early stopping

### 2. 评估模型性能
- Reward曲线上升表明模型性能提升
- 对比不同训练配置的效果
- 找出最佳的epoch checkpoint

### 3. 调试训练问题
- Loss突然上升可能表示学习率过大
- Reward震荡可能需要调整batch size
- 平稳不变可能表示陷入局部最优

## 优化建议

### 前端优化
1. **图片预加载**：使用Image对象预加载新图片
2. **平滑过渡**：添加CSS过渡动画
3. **缓存控制**：URL添加时间戳防止浏览器缓存

### 性能优化
1. **按需绘制**：可以设置每N个epoch更新一次图表
2. **图片压缩**：调整DPI降低文件大小
3. **异步生成**：将绘图放在单独线程避免阻塞训练

## 示例效果

训练5个epoch后的曲线示例：

```
Epoch 1: Loss=10.2, Reward=-15.3
Epoch 2: Loss=9.5,  Reward=-13.8
Epoch 3: Loss=8.7,  Reward=-12.1  ← Best
Epoch 4: Loss=8.3,  Reward=-12.5
Epoch 5: Loss=7.9,  Reward=-11.9
```

对应的图表会显示：
- Loss曲线：从10.2逐渐下降到7.9
- Reward曲线：从-15.3上升到-11.9，在Epoch 3处用星标标注最佳值

## 技术细节

### 图表配置
- 图表尺寸：10x8英寸
- 分辨率：150 DPI
- 格式：PNG（支持透明背景）
- 中文字体：SimHei / Microsoft YaHei

### 线条样式
- Loss曲线：蓝色实线，圆形标记点
- Reward曲线：绿色实线，圆形标记点
- Best标记：红色虚线 + 星形标记点

### 容错处理
- 绘图失败时发送`warning`消息，不中断训练
- 自动捕获异常并记录详细错误信息

## 兼容性说明

该功能完全兼容现有系统：
- ✅ 不影响训练流程
- ✅ 不修改模型逻辑
- ✅ 向后兼容旧版前端
- ✅ 支持模拟训练模式

如果前端不处理`plot`消息，训练仍然正常进行，只是不显示实时曲线图。

