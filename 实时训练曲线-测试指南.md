# 实时训练曲线功能 - 测试指南

## ✅ 修改完成

已完成以下修改以实现实时训练曲线显示功能：

### 后端修改（app.py）
- ✅ 在 `ProgressCallback` 类中添加历史数据记录
- ✅ 每个epoch结束后自动生成训练曲线图（Loss + Reward双子图）
- ✅ 通过SSE推送 `plot` 消息到前端

### 前端修改（templates/index.html）
- ✅ 添加训练曲线显示区域（第623-633行）
- ✅ 在SSE消息处理中添加 `plot` 类型处理（第765-768行）
- ✅ 实现 `updateTrainingCurve()` 函数（第805-826行）
- ✅ 训练完成时也显示最终训练曲线（第897-911行）

## 🚀 测试步骤

### 1. 启动服务器
```bash
cd F:\Github\rl4co-display
python app.py
```

### 2. 打开浏览器
```
http://localhost:5000/home
```

### 3. 配置训练参数（建议用小参数快速测试）
- **模型**: Attention Model
- **问题类型**: TSP
- **训练轮数**: **5**（建议从小数量开始测试）
- **批次大小**: 512
- **学习率**: 0.0001

### 4. 点击"开始训练"

### 5. 观察现象

#### ✅ 应该看到的效果：

**训练开始后：**
- 进度容器显示
- 训练日志开始输出

**第1个epoch完成后：**
- 📈 日志显示："📊 Epoch 1 训练曲线已更新"
- 📈 训练曲线区域出现（"📈 训练曲线（实时更新）"标题）
- 📈 显示包含1个数据点的图表：
  - 上方：蓝色Loss点
  - 下方：绿色Reward点 + 红色星标（最佳值）

**第2个epoch完成后：**
- 📈 日志显示："📊 Epoch 2 训练曲线已更新"
- 📈 图表自动刷新，显示2个数据点连成的折线
- 📈 红色星标移动到当前最佳Reward的位置

**第3、4、5个epoch：**
- 📈 每个epoch完成都会更新曲线
- 📈 折线越来越长，可以看到趋势
- 📈 Loss应该逐渐下降（蓝色线向下）
- 📈 Reward应该逐渐上升（绿色线向上）

**训练完成后：**
- ✅ 显示"训练完成"面板
- 📈 在结果中也会显示最终的训练曲线图
- 📊 下方显示路径对比图和动态GIF

## 🔍 调试检查

### 1. 检查后端生成的图片
在训练过程中，打开文件夹：
```
F:\Github\rl4co-display\static\model_plots\
```

应该看到：
```
training_curves_<session_id前8位>.png  ← 训练曲线图
comparison_<session_id前8位>_1.png     ← 路径对比图
animation_<session_id前8位>_1.gif      ← 路径动画
```

每次epoch完成后，`training_curves_*.png` 文件会被更新。

### 2. 检查浏览器控制台
按 `F12` 打开开发者工具 → Console标签

**正常情况应该看到：**
```
[Network] EventSource connected to /api/training_progress/<session_id>
```

**每个epoch完成后应该收到：**
```json
{
  "type": "plot",
  "plot_url": "/static/model_plots/training_curves_12345678.png",
  "message": "Epoch 1 训练曲线已更新"
}
```

### 3. 检查Network标签
F12 → Network → 找到 `training_progress` 请求

**查看EventStream消息：**
```
data: {"type":"info","message":"开始训练..."}
data: {"type":"progress","epoch":1,...}
data: {"type":"plot","plot_url":"/static/model_plots/training_curves_12345678.png",...}
data: {"type":"progress","epoch":2,...}
data: {"type":"plot","plot_url":"/static/model_plots/training_curves_12345678.png",...}
...
```

## ❌ 可能的问题和解决方案

### 问题1：前端没有显示曲线区域
**检查：**
- 浏览器控制台是否有JavaScript错误
- SSE连接是否正常建立
- 是否收到了 `plot` 类型的消息

**解决：**
- 刷新页面（Ctrl+F5 强制刷新）
- 清除浏览器缓存
- 检查浏览器是否支持EventSource

### 问题2：图片不更新或显示旧图片
**原因：** 浏览器缓存

**解决：**
- 代码已添加时间戳参数 `?t=timestamp`
- 如果仍然缓存，手动清除浏览器缓存
- 或者右键图片 → 在新标签页打开

### 问题3：后端生成图片但前端不显示
**检查：**
1. 图片路径是否正确
   ```javascript
   console.log(plotUrl);  // 应该输出：/static/model_plots/training_curves_12345678.png
   ```

2. 直接访问图片URL测试：
   ```
   http://localhost:5000/static/model_plots/training_curves_12345678.png
   ```

3. 检查static目录权限

### 问题4：训练日志显示"生成训练曲线失败"
**原因：** matplotlib绘图异常

**检查后端控制台：**
- 查看详细错误信息
- 可能是中文字体问题
- 可能是matplotlib版本问题

**解决：**
```bash
# 重新安装matplotlib
pip install --upgrade matplotlib

# 安装中文字体支持
# Windows通常自带SimHei和Microsoft YaHei
```

## 📸 预期效果截图说明

### 训练中（实时更新）
```
┌─────────────────────────────────────┐
│ 📈 训练曲线（实时更新）              │
├─────────────────────────────────────┤
│                                     │
│  [上方] 训练Loss变化曲线            │
│    ┌───────────────────┐            │
│    │    ●━━●━━●         │  蓝色     │
│    │   ↓               │  向下趋势  │
│    └───────────────────┘            │
│                                     │
│  [下方] 训练Reward变化曲线          │
│    ┌───────────────────┐            │
│    │        ●━━●━━●     │  绿色     │
│    │      ↑   ★         │  向上趋势  │
│    │   (红色星标=最佳)  │           │
│    └───────────────────┘            │
│                                     │
│  ✓ Epoch 5 训练曲线已更新           │
└─────────────────────────────────────┘
```

### 训练完成（最终结果）
在"训练完成"面板中会显示：
1. **训练曲线**：完整的Loss和Reward变化图
2. **路径对比图**：随机策略 vs 训练后策略
3. **动态GIF**：路径逐步构建过程

## 🎯 功能验证清单

训练5个epoch后，应该全部打勾：

- [ ] 后端生成了 `training_curves_*.png` 文件
- [ ] 前端显示了"📈 训练曲线（实时更新）"区域
- [ ] 每个epoch都更新了曲线图
- [ ] 图表有蓝色Loss线和绿色Reward线
- [ ] 红色星标标注在最佳Reward的位置
- [ ] 训练日志显示"📊 Epoch X 训练曲线已更新"
- [ ] 训练完成后在结果面板也显示了最终曲线
- [ ] 图片不是缓存的（每次更新确实改变）

## 💡 高级测试

### 测试长时间训练
```
Epochs: 20
```
观察：
- 曲线是否平滑
- 是否有收敛趋势
- 最佳值标注是否准确

### 测试多次训练
连续训练多次，检查：
- 每次session_id不同
- 生成不同的曲线图文件
- 不会互相覆盖

### 压力测试
```
Epochs: 100
Batch Size: 1024
```
观察：
- 是否每个epoch都正常更新
- 前端是否流畅
- 内存占用情况

## 📚 相关文档

- `实时训练曲线功能说明.md` - 详细功能文档
- `实时训练曲线前端示例.html` - 独立前端示例
- `实时训练曲线-修改总结.md` - 技术实现总结

## 🆘 问题反馈

如果遇到问题：
1. 检查浏览器控制台错误信息
2. 检查后端Python控制台输出
3. 检查 `static/model_plots/` 目录是否有图片
4. 尝试直接访问图片URL
5. 清除浏览器缓存后重试

---

**现在就去测试吧！** 🚀

启动训练后，你应该能看到Loss和Reward的实时变化曲线！

