<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TSPè®­ç»ƒ - å®æ—¶æ›²çº¿ç›‘æ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .training-config {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .config-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .config-item label {
            display: block;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .config-item input, .config-item select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .start-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .start-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .training-area {
            display: none;
            animation: fadeIn 0.5s;
        }

        .training-area.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .metric-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .metric-value.loss { color: #e74c3c; }
        .metric-value.reward { color: #27ae60; }
        .metric-value.best { color: #f39c12; }

        .curves-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .curves-section h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .update-badge {
            font-size: 12px;
            background: #27ae60;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        #trainingCurveImg {
            width: 100%;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: opacity 0.3s ease;
        }

        .log-section {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-section h3 {
            color: #ecf0f1;
            margin-bottom: 10px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid #3498db;
            padding-left: 10px;
        }

        .log-entry.info { border-left-color: #3498db; }
        .log-entry.progress { border-left-color: #27ae60; }
        .log-entry.error { border-left-color: #e74c3c; }
        .log-entry.warning { border-left-color: #f39c12; }
        .log-entry.plot { border-left-color: #9b59b6; }

        .results-section {
            display: none;
            background: #d4edda;
            border: 2px solid #c3e6cb;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .results-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .results-section h2 {
            color: #155724;
            margin-bottom: 15px;
        }

        .no-curve-placeholder {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ TSPè®­ç»ƒ - å®æ—¶æ›²çº¿ç›‘æ§</h1>

        <!-- é…ç½®åŒºåŸŸ -->
        <div class="training-config">
            <h2>è®­ç»ƒé…ç½®</h2>
            <div class="config-row">
                <div class="config-item">
                    <label>æ¨¡å‹ç±»å‹</label>
                    <select id="modelType">
                        <option value="attention">Attention Model</option>
                        <option value="pomo">POMO</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>é—®é¢˜ç±»å‹</label>
                    <select id="problemType">
                        <option value="tsp">TSP</option>
                        <option value="cvrp">CVRP</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>è®­ç»ƒè½®æ•° (Epochs)</label>
                    <input type="number" id="epochs" value="10" min="1" max="100">
                </div>
                <div class="config-item">
                    <label>æ‰¹å¤§å° (Batch Size)</label>
                    <input type="number" id="batchSize" value="512" min="32" max="2048" step="32">
                </div>
                <div class="config-item">
                    <label>å­¦ä¹ ç‡ (Learning Rate)</label>
                    <input type="number" id="learningRate" value="0.0001" step="0.0001" min="0.00001">
                </div>
            </div>
            <button class="start-btn" id="startBtn" onclick="startTraining()">å¼€å§‹è®­ç»ƒ</button>
        </div>

        <!-- è®­ç»ƒåŒºåŸŸ -->
        <div class="training-area" id="trainingArea">
            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div class="progress-section">
                <h2>è®­ç»ƒè¿›åº¦</h2>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-label">å½“å‰Epoch</div>
                        <div class="metric-value" id="currentEpoch">0</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Loss</div>
                        <div class="metric-value loss" id="currentLoss">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Reward</div>
                        <div class="metric-value reward" id="currentReward">-</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Best Reward</div>
                        <div class="metric-value best" id="bestReward">-</div>
                    </div>
                </div>
            </div>

            <!-- è®­ç»ƒæ›²çº¿æ˜¾ç¤º -->
            <div class="curves-section">
                <h2>
                    è®­ç»ƒæ›²çº¿ï¼ˆå®æ—¶æ›´æ–°ï¼‰
                    <span class="update-badge" id="updateBadge" style="display: none;">æ›´æ–°ä¸­...</span>
                </h2>
                <div id="curveContainer">
                    <div class="no-curve-placeholder">
                        ç­‰å¾…è®­ç»ƒæ•°æ®...
                    </div>
                </div>
            </div>

            <!-- è®­ç»ƒæ—¥å¿— -->
            <div class="log-section">
                <h3>ğŸ“ è®­ç»ƒæ—¥å¿—</h3>
                <div id="logContainer"></div>
            </div>

            <!-- è®­ç»ƒå®Œæˆç»“æœ -->
            <div class="results-section" id="resultsSection">
                <h2>âœ… è®­ç»ƒå®Œæˆï¼</h2>
                <div id="resultsContent"></div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let eventSource = null;

        // å¼€å§‹è®­ç»ƒ
        async function startTraining() {
            const config = {
                model: document.getElementById('modelType').value,
                problem: document.getElementById('problemType').value,
                epochs: parseInt(document.getElementById('epochs').value),
                batch_size: parseInt(document.getElementById('batchSize').value),
                learning_rate: parseFloat(document.getElementById('learningRate').value)
            };

            // ç¦ç”¨å¼€å§‹æŒ‰é’®
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = 'è®­ç»ƒä¸­...';

            try {
                const response = await fetch('/api/start_training', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.success) {
                    currentSessionId = result.session_id;
                    addLog('info', result.message);
                    
                    // æ˜¾ç¤ºè®­ç»ƒåŒºåŸŸ
                    document.getElementById('trainingArea').classList.add('active');
                    
                    // å¼€å§‹ç›‘å¬è®­ç»ƒè¿›åº¦
                    subscribeToProgress(currentSessionId);
                } else {
                    addLog('error', result.message);
                    startBtn.disabled = false;
                    startBtn.textContent = 'å¼€å§‹è®­ç»ƒ';
                }
            } catch (error) {
                addLog('error', 'å¯åŠ¨è®­ç»ƒå¤±è´¥: ' + error.message);
                startBtn.disabled = false;
                startBtn.textContent = 'å¼€å§‹è®­ç»ƒ';
            }
        }

        // è®¢é˜…è®­ç»ƒè¿›åº¦
        function subscribeToProgress(sessionId) {
            eventSource = new EventSource(`/api/training_progress/${sessionId}`);

            eventSource.addEventListener('message', function(event) {
                const data = JSON.parse(event.data);
                handleTrainingMessage(data);
            });

            eventSource.addEventListener('error', function(event) {
                console.error('SSEè¿æ¥é”™è¯¯', event);
                addLog('error', 'SSEè¿æ¥ä¸­æ–­');
            });
        }

        // å¤„ç†è®­ç»ƒæ¶ˆæ¯
        function handleTrainingMessage(data) {
            switch(data.type) {
                case 'info':
                    addLog('info', data.message);
                    break;

                case 'progress':
                    updateProgress(data);
                    addLog('progress', data.message || 
                        `Epoch ${data.epoch}/${data.total_epochs} - Loss: ${data.loss}, Reward: ${data.reward}`);
                    break;

                case 'plot':
                    updateTrainingCurve(data.plot_url, data.message);
                    addLog('plot', data.message);
                    break;

                case 'warning':
                    addLog('warning', data.message);
                    break;

                case 'error':
                    addLog('error', data.message);
                    handleTrainingComplete(false);
                    break;

                case 'complete':
                    addLog('info', data.message);
                    handleTrainingComplete(true, data.results);
                    break;

                case 'heartbeat':
                    // å¿ƒè·³æ¶ˆæ¯ï¼Œä¸åšå¤„ç†
                    break;
            }
        }

        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress(data) {
            // æ›´æ–°è¿›åº¦æ¡
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = data.progress + '%';
            progressBar.textContent = data.progress.toFixed(1) + '%';

            // æ›´æ–°æŒ‡æ ‡å¡ç‰‡
            document.getElementById('currentEpoch').textContent = 
                `${data.epoch} / ${data.total_epochs}`;
            document.getElementById('currentLoss').textContent = data.loss.toFixed(4);
            document.getElementById('currentReward').textContent = data.reward.toFixed(4);
            document.getElementById('bestReward').textContent = data.best_reward.toFixed(4);
        }

        // æ›´æ–°è®­ç»ƒæ›²çº¿å›¾
        function updateTrainingCurve(plotUrl, message) {
            const container = document.getElementById('curveContainer');
            const updateBadge = document.getElementById('updateBadge');
            
            // æ˜¾ç¤ºæ›´æ–°æ ‡è¯†
            updateBadge.style.display = 'inline-block';
            
            // åˆ›å»ºæˆ–æ›´æ–°å›¾ç‰‡
            let img = document.getElementById('trainingCurveImg');
            if (!img) {
                img = document.createElement('img');
                img.id = 'trainingCurveImg';
                img.alt = 'è®­ç»ƒæ›²çº¿';
                container.innerHTML = '';
                container.appendChild(img);
            }

            // æ·»åŠ æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
            img.style.opacity = '0.5';
            img.src = plotUrl + '?t=' + new Date().getTime();
            
            img.onload = function() {
                img.style.opacity = '1';
                updateBadge.style.display = 'none';
            };
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(type, message) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // å¤„ç†è®­ç»ƒå®Œæˆ
        function handleTrainingComplete(success, results) {
            // å…³é—­SSEè¿æ¥
            if (eventSource) {
                eventSource.close();
            }

            // é‡æ–°å¯ç”¨å¼€å§‹æŒ‰é’®
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = false;
            startBtn.textContent = 'å¼€å§‹è®­ç»ƒ';

            if (success && results) {
                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                const resultsSection = document.getElementById('resultsSection');
                const resultsContent = document.getElementById('resultsContent');
                
                resultsContent.innerHTML = `
                    <p><strong>æ¨¡å‹:</strong> ${results.model}</p>
                    <p><strong>é—®é¢˜:</strong> ${results.problem}</p>
                    <p><strong>ç­–ç•¥:</strong> ${results.strategy}</p>
                    <p><strong>æ€»è½®æ•°:</strong> ${results.total_epochs}</p>
                    <p><strong>æœ€ç»ˆLoss:</strong> ${results.final_loss}</p>
                    <p><strong>æœ€ç»ˆReward:</strong> ${results.final_reward}</p>
                    <p><strong>æœ€ä½³Reward:</strong> ${results.best_reward}</p>
                    ${results.training_curve ? 
                        `<p><strong>è®­ç»ƒæ›²çº¿:</strong> <a href="${results.training_curve}" target="_blank">æŸ¥çœ‹</a></p>` : ''}
                    ${results.checkpoint_path ? 
                        `<p><strong>æ£€æŸ¥ç‚¹:</strong> ${results.checkpoint_path}</p>` : ''}
                `;
                
                resultsSection.classList.add('active');
            }
        }
    </script>
</body>
</html>

