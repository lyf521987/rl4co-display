# RL4CO Display 部署完整指南

> 让你的强化学习平台在互联网上运行

## 📋 目录
1. [本地开发环境](#本地开发环境)
2. [生产环境部署](#生产环境部署)
3. [云平台部署](#云平台部署)
4. [域名和 HTTPS](#域名和-https)
5. [性能优化](#性能优化)
6. [监控和维护](#监控和维护)
7. [常见问题解决](#常见问题解决)

---

## 本地开发环境

### 快速启动（5 分钟）

```bash
# 1. 克隆项目
git clone https://github.com/your-repo/rl4co-display.git
cd rl4co-display

# 2. 创建虚拟环境
python -m venv venv

# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate

# 3. 安装依赖
pip install -r requirements.txt

# 4. 配置数据库（已有数据库的跳过）
# 编辑 config.py，填入你的 MySQL 信息
# 然后运行初始化脚本
mysql -u root -p flaskdemo_user < database_init_with_auth.sql

# 5. 启动应用
python app.py
```

访问 `http://localhost:5000` 即可！

---

## 生产环境部署

### 方法 1：使用 Systemd 服务（推荐 - Linux）

#### 步骤 1: 准备服务器环境

```bash
# 登录到你的 Linux 服务器（Ubuntu/CentOS/Debian）
ssh user@your-server-ip

# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装必要的软件
sudo apt install -y python3.9 python3-pip mysql-server nginx git

# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql  # 开机自启

# 启动 Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 步骤 2: 部署应用

```bash
# 创建应用目录
sudo mkdir -p /opt/rl4co-display
cd /opt/rl4co-display

# 克隆项目
sudo git clone https://github.com/your-repo/rl4co-display.git .

# 设置权限
sudo chown -R $USER:$USER /opt/rl4co-display

# 创建虚拟环境
python3.9 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
pip install gunicorn
```

#### 步骤 3: 配置 MySQL 数据库

```bash
# 登录 MySQL
mysql -u root -p

# 执行以下命令
CREATE DATABASE flaskdemo_user CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EXIT;

# 初始化数据表
mysql -u root -p flaskdemo_user < database_init_with_auth.sql
```

#### 步骤 4: 配置应用

编辑 `/opt/rl4co-display/config.py`：

```python
class Config:
    MYSQL_HOST = 'localhost'
    MYSQL_USER = 'root'
    MYSQL_PASSWORD = 'your_secure_password'  # 改为你的密码
    MYSQL_DB = 'flaskdemo_user'
```

#### 步骤 5: 创建 Systemd 服务文件

创建 `/etc/systemd/system/rl4co-display.service`：

```ini
[Unit]
Description=RL4CO Display Web Application
After=network.target mysql.service

[Service]
Type=notify
User=www-data
WorkingDirectory=/opt/rl4co-display
Environment="PATH=/opt/rl4co-display/venv/bin"
ExecStart=/opt/rl4co-display/venv/bin/gunicorn \
    -w 4 \
    -b 127.0.0.1:5000 \
    --timeout 300 \
    --access-logfile /var/log/rl4co-display/access.log \
    --error-logfile /var/log/rl4co-display/error.log \
    app:app

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

#### 步骤 6: 启动服务

```bash
# 创建日志目录
sudo mkdir -p /var/log/rl4co-display
sudo chown www-data:www-data /var/log/rl4co-display

# 重新加载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start rl4co-display
sudo systemctl enable rl4co-display

# 检查状态
sudo systemctl status rl4co-display

# 查看日志
sudo journalctl -u rl4co-display -f
```

#### 步骤 7: 配置 Nginx 反向代理

编辑 `/etc/nginx/sites-available/rl4co`：

```nginx
upstream rl4co_app {
    server 127.0.0.1:5000;
}

server {
    listen 80;
    server_name your-domain.com;  # 改为你的域名

    client_max_body_size 100M;

    # 日志配置
    access_log /var/log/nginx/rl4co-access.log;
    error_log /var/log/nginx/rl4co-error.log;

    # 前端应用
    location / {
        proxy_pass http://rl4co_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 实时数据支持
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 300s;
    }

    # 静态文件
    location /static {
        alias /opt/rl4co-display/static;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/rl4co /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl reload nginx
```

#### 步骤 8: 添加 HTTPS（Let's Encrypt）

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-nginx

# 申请证书
sudo certbot --nginx -d your-domain.com

# 自动更新证书
sudo systemctl enable certbot.timer
sudo systemctl start certbot.timer
```

证书申请成功后，Nginx 配置会自动更新。

### 方法 2：使用 Docker

#### 创建 Dockerfile

项目已包含 Dockerfile，如果没有，创建一个：

```dockerfile
FROM python:3.9-slim

WORKDIR /app

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 复制依赖文件
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
RUN pip install --no-cache-dir gunicorn

# 复制项目文件
COPY . .

# 创建必要的目录
RUN mkdir -p static/model_plots checkpoints

# 暴露端口
EXPOSE 5000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:5000/').read()"

# 启动命令
CMD ["gunicorn", "-w", "4", "-b", "0.0.0.0:5000", "--timeout", "300", "app:app"]
```

#### 构建和运行

```bash
# 构建镜像
docker build -t rl4co-display:latest .

# 运行容器
docker run -d \
  --name rl4co-display \
  -p 5000:5000 \
  -v /path/to/static/model_plots:/app/static/model_plots \
  -v /path/to/checkpoints:/app/checkpoints \
  -e MYSQL_HOST=your-mysql-host \
  -e MYSQL_USER=root \
  -e MYSQL_PASSWORD=your-password \
  rl4co-display:latest

# 查看日志
docker logs -f rl4co-display
```

#### Docker Compose 方式（推荐）

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  # MySQL 数据库
  mysql:
    image: mysql:8.0
    container_name: rl4co-mysql
    environment:
      MYSQL_ROOT_PASSWORD: your_secure_password
      MYSQL_DATABASE: flaskdemo_user
      MYSQL_CHARSET: utf8mb4
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database_init_with_auth.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - rl4co-network

  # Flask 应用
  app:
    build: .
    container_name: rl4co-app
    depends_on:
      - mysql
    environment:
      MYSQL_HOST: mysql
      MYSQL_USER: root
      MYSQL_PASSWORD: your_secure_password
      MYSQL_DB: flaskdemo_user
    ports:
      - "5000:5000"
    volumes:
      - ./static/model_plots:/app/static/model_plots
      - ./checkpoints:/app/checkpoints
    networks:
      - rl4co-network

  # Nginx 反向代理
  nginx:
    image: nginx:alpine
    container_name: rl4co-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - app
    networks:
      - rl4co-network

volumes:
  mysql_data:

networks:
  rl4co-network:
    driver: bridge
```

启动服务：

```bash
docker-compose up -d

# 查看状态
docker-compose ps

# 查看日志
docker-compose logs -f app
```

---

## 云平台部署

### 阿里云 ECS

#### 快速部署步骤

1. **购买 ECS 实例**
   - 推荐配置：2核 4GB 内存，20GB 存储
   - 操作系统：Ubuntu 20.04 LTS

2. **配置安全组**
   - 允许 80 (HTTP)、443 (HTTPS)、22 (SSH) 端口

3. **部署应用**

```bash
# 连接到实例
ssh -i /path/to/key.pem ubuntu@your-instance-ip

# 按照"方法 1: Systemd 服务"的步骤部署
```

### 腾讯云轻量级应用服务器

1. **创建应用服务器**
   - 选择 WordPress 或 Linux 镜像
   - 1 核 2GB 内存即可

2. **通过 WebShell 连接**

3. **部署应用**
   - 同上面的步骤

### 容器化云平台

#### AWS ECS
```bash
# 推送镜像到 ECR
aws ecr get-login-password | docker login --username AWS --password-stdin your-account-id.dkr.ecr.region.amazonaws.com
docker tag rl4co-display:latest your-account-id.dkr.ecr.region.amazonaws.com/rl4co-display:latest
docker push your-account-id.dkr.ecr.region.amazonaws.com/rl4co-display:latest

# 在 ECS 中创建任务定义并运行
```

#### 百度云 BCC
- 类似阿里云 ECS，参考官方文档

---

## 域名和 HTTPS

### 购买域名

1. **选择域名服务商**
   - 国外：Namecheap、GoDaddy
   - 国内：万网、新网、西部数码

2. **配置 DNS**
   - 添加 A 记录指向你的服务器 IP

### 配置 HTTPS

#### 使用 Let's Encrypt (免费)

```bash
sudo certbot --nginx -d your-domain.com
```

#### 使用付费证书

1. 购买 SSL 证书
2. 上传证书到服务器
3. 在 Nginx 中配置

```nginx
server {
    listen 443 ssl;
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 强制 HTTPS
    add_header Strict-Transport-Security "max-age=31536000" always;
}

# HTTP 自动跳转 HTTPS
server {
    listen 80;
    return 301 https://$server_name$request_uri;
}
```

---

## 性能优化

### 1. 数据库优化

```sql
-- 添加索引
ALTER TABLE training_files ADD INDEX idx_user_id (user_id);
ALTER TABLE training_sessions ADD INDEX idx_user_id (user_id);

-- 定期清理
DELETE FROM training_sessions WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

### 2. 调整 Gunicorn Worker 数量

根据 CPU 核心数调整：

```bash
# 查看 CPU 核心数
nproc

# 推荐 worker 数 = 2 * CPU 核心数 + 1
gunicorn -w $((2 * $(nproc) + 1)) -b 0.0.0.0:5000 app:app
```

### 3. 启用静态文件缓存

在 Nginx 配置中：

```nginx
location /static {
    alias /opt/rl4co-display/static;
    expires 30d;
    add_header Cache-Control "public, immutable";
    gzip on;
    gzip_types text/css application/javascript image/svg+xml;
}
```

### 4. 启用 Redis 缓存（可选）

```bash
# 安装 Redis
sudo apt install -y redis-server
sudo systemctl start redis-server

# 安装 Python 包
pip install redis flask-caching
```

### 5. GPU 加速

```bash
# 检查 GPU
nvidia-smi

# 安装 CUDA 版 PyTorch
pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118
```

---

## 监控和维护

### 1. 监控系统资源

```bash
# 实时监控
htop

# 磁盘使用
df -h

# 内存使用
free -h
```

### 2. 监控应用日志

```bash
# Systemd 服务
sudo journalctl -u rl4co-display -f

# Nginx 日志
sudo tail -f /var/log/nginx/rl4co-error.log

# 应用日志
sudo tail -f /var/log/rl4co-display/error.log
```

### 3. 数据库备份

创建备份脚本 `/usr/local/bin/backup-rl4co.sh`：

```bash
#!/bin/bash
BACKUP_DIR="/backup/rl4co-display"
DATE=$(date +\%Y\%m\%d_\%H\%M\%S)

mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u root -p$MYSQL_PASSWORD flaskdemo_user > $BACKUP_DIR/db_$DATE.sql

# 压缩
gzip $BACKUP_DIR/db_$DATE.sql

# 删除 30 天前的备份
find $BACKUP_DIR -type f -mtime +30 -delete

echo "Backup completed: $BACKUP_DIR/db_$DATE.sql.gz"
```

设置定时备份：

```bash
crontab -e

# 添加
0 2 * * * /usr/local/bin/backup-rl4co.sh >> /var/log/rl4co-backup.log 2>&1
```

### 4. 更新应用

```bash
cd /opt/rl4co-display

# 拉取最新代码
git pull

# 安装新依赖
source venv/bin/activate
pip install -r requirements.txt --upgrade

# 重启服务
sudo systemctl restart rl4co-display
```

---

## 常见问题解决

### 问题 1: 部署后打不开网站

**症状**：无法访问 http://your-domain.com

**排查步骤**：

```bash
# 1. 检查防火墙
sudo ufw status
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 2. 检查 DNS 解析
nslookup your-domain.com
ping your-domain.com

# 3. 检查 Nginx 状态
sudo systemctl status nginx
sudo nginx -t

# 4. 检查应用状态
sudo systemctl status rl4co-display

# 5. 查看日志
sudo journalctl -u rl4co-display -n 50
```

### 问题 2: 502 Bad Gateway

**原因**：Gunicorn 进程崩溃或 Nginx 无法连接

**解决**：

```bash
# 重启应用
sudo systemctl restart rl4co-display

# 查看错误日志
sudo journalctl -u rl4co-display -f

# 查看 Nginx 日志
sudo tail -f /var/log/nginx/rl4co-error.log
```

### 问题 3: 数据库连接失败

**症状**：显示"认证模块初始化失败"

**解决**：

```bash
# 1. 检查 MySQL 状态
sudo systemctl status mysql

# 2. 验证数据库连接
mysql -h localhost -u root -p flaskdemo_user -e "SELECT 1"

# 3. 检查配置文件
cat /opt/rl4co-display/config.py

# 4. 查看应用日志
sudo journalctl -u rl4co-display
```

### 问题 4: 训练内存不足

**症状**：训练时 OOM 或 Out of Memory

**解决**：

```bash
# 减少 batch size（在训练配置中）
# 或增加 swap
sudo fallocate -l 4G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 问题 5: SSL 证书过期

```bash
# 自动续期（Let's Encrypt）
sudo certbot renew --dry-run

# 手动续期
sudo certbot renew
```

---

## 监控清单

部署后建议定期检查：

- [ ] 网站能否正常访问
- [ ] HTTPS 证书有效期
- [ ] 磁盘空间使用情况（> 80% 需要清理）
- [ ] 数据库大小
- [ ] 最近的备份时间
- [ ] 应用错误日志

---

## 获取帮助

如有问题，可以：

1. 查看详细文档：[DEPLOYMENT.md](../DEPLOYMENT.md)
2. 查看主文档：[README.md](../README.md)
3. 提交 Issue 到 GitHub

---

**祝部署顺利！** 🚀



