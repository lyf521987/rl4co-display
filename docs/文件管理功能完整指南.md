# 训练文件管理功能 - 完整指南

> 为 RL4CO 训练平台提供完整的文件管理功能，包括查看、删除和管理训练产生的所有文件。

---

## 📋 目录

1. [功能概述](#功能概述)
2. [快速开始](#快速开始)
3. [功能特性](#功能特性)
4. [API 接口文档](#api-接口文档)
5. [使用指南](#使用指南)
6. [安全机制](#安全机制)
7. [实现细节](#实现细节)
8. [故障排查](#故障排查)

---

## 功能概述

### 管理的文件类型

#### 📊 可视化文件 (`static/model_plots/`)
- `comparison_*.png` - 训练前后路线对比图 (~0.2 MB)
- `animation_*.gif` - 动态路线构建过程 (1-5 MB)
- `training_curves_*.png` - 训练Loss和Reward曲线 (~0.3 MB)

#### 💾 模型检查点 (`checkpoints/`)
- `*.ckpt` - 训练完成的模型权重文件 (50-100 MB)

### 核心功能
- ✅ 查看所有训练文件及其详细信息
- ✅ 实时显示文件数量和总占用空间统计
- ✅ 预览图片文件
- ✅ 删除单个文件
- ✅ 批量删除（按会话）
- ✅ 清空所有文件
- ✅ 刷新文件列表

---

## 快速开始

### 🚀 5分钟上手

#### 1. 打开文件管理页面

**方法一：通过导航栏**
```
主页 → 点击顶部导航 "文件管理"
```

**方法二：直接访问**
```
http://localhost:5000/file_manager
```

#### 2. 查看文件统计

页面顶部显示4个统计卡片：
```
┌───────────────────────────────────────────────────┐
│  总文件数: 12  可视化文件: 9  检查点: 3  空间: 125 MB │
└───────────────────────────────────────────────────┘
```

#### 3. 常见操作

| 操作 | 步骤 |
|------|------|
| **查看文件** | 点击 "👁️ 查看" → 新标签页打开 |
| **删除文件** | 点击 "🗑️ 删除" → 确认 → 删除完成 |
| **刷新列表** | 点击顶部 "🔄 刷新列表" |
| **清空所有** | 点击 "🗑️ 清空所有文件" → 确认 → 全部删除 |

---

## 功能特性

### 1. 文件展示

#### 📁 文件类型标识

| 类型 | 标识 | 说明 | 大小范围 |
|------|------|------|----------|
| **对比图** | 🔵 蓝色 | 训练前后路线对比 | ~0.2 MB |
| **动画** | 🟢 绿色 | 路线构建过程GIF | 1-5 MB |
| **训练曲线** | 🟡 黄色 | Loss和Reward曲线 | ~0.3 MB |
| **检查点** | 🔴 红色 | 模型权重文件 | 50-100 MB |

#### 🎨 界面特性

**响应式设计**
- 自适应不同屏幕尺寸
- 卡片网格自动调整列数
- 移动端友好

**视觉反馈**
- 悬停动画效果
- 文件类型颜色编码
- 实时大小/时间显示
- 确认对话框防误操作

### 2. 文件统计

**实时统计信息**
- 总文件数量
- 分类文件计数
- 总占用空间（MB）
- 最近修改时间

**单次训练产生的文件**
```
对比图:    3 张 × 0.3 MB = 0.9 MB
动画:      3 个 × 2 MB   = 6 MB
训练曲线:  1 张 × 0.3 MB = 0.3 MB
检查点:    1 个 × 70 MB  = 70 MB
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
总计:      约 77 MB / 次训练
```

---

## API 接口文档

### 1. 列出所有文件

**接口**: `GET /api/list_files`

**功能**: 获取所有训练产生的文件列表及统计信息

**响应示例**:
```json
{
  "success": true,
  "files": {
    "plots": [
      {
        "name": "comparison_31401239_1.png",
        "type": "comparison",
        "size": 245678,
        "size_mb": 0.23,
        "path": "/static/model_plots/comparison_31401239_1.png",
        "modified": 1704067200.123
      }
    ],
    "checkpoints": [
      {
        "name": "tsp-attention.ckpt",
        "type": "checkpoint",
        "size": 52428800,
        "size_mb": 50.0,
        "path": "checkpoints/tsp-attention.ckpt",
        "modified": 1704067200.456
      }
    ],
    "total_count": 7,
    "total_size": 104857600,
    "total_size_mb": 100.0
  }
}
```

### 2. 删除单个文件

**接口**: `POST /api/delete_file`

**功能**: 删除指定的训练文件

**请求体**:
```json
{
  "filename": "comparison_31401239_1.png",
  "file_type": "plot"  // 或 "checkpoint"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "文件 comparison_31401239_1.png 已删除"
}
```

**使用示例（JavaScript）**:
```javascript
fetch('/api/delete_file', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    filename: 'comparison_31401239_1.png',
    file_type: 'plot'
  })
})
.then(res => res.json())
.then(data => console.log(data));
```

### 3. 根据会话ID批量删除

**接口**: `POST /api/delete_by_session`

**功能**: 删除特定训练会话产生的所有文件

**请求体**:
```json
{
  "session_id": "31401239-abcd-1234-5678-1234567890ab"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "已删除 7 个文件",
  "deleted_files": [
    "comparison_31401239_1.png",
    "comparison_31401239_2.png",
    "animation_31401239_1.gif",
    "training_curves_31401239.png"
  ]
}
```

**使用场景**: 训练完成后，如果用户不满意结果，可以一键删除该次训练的所有文件。

### 4. 清空所有文件

**接口**: `POST /api/clear_all_files`

**功能**: 删除所有训练产生的文件（⚠️ 危险操作）

**请求体**:
```json
{
  "confirm": true  // 必须为 true 才会执行
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "已清空所有文件，共删除 15 个文件"
}
```

**安全机制**:
- 必须明确传递 `confirm: true` 才会执行
- 前端会进行二次确认对话框
- 适用于重置系统或定期清理

---

## 使用指南

### 💡 使用建议

#### 何时删除文件？
- ✅ 训练结果不满意
- ✅ 磁盘空间不足
- ✅ 只是测试训练流程
- ✅ 定期清理旧文件

#### 何时保留文件？
- ❌ 训练效果良好
- ❌ 需要展示结果
- ❌ 模型检查点用于后续训练
- ❌ 用于论文或报告

#### 删除优先级
1. **先删除**: 动画GIF（占用空间大）
2. **再删除**: 旧的对比图和训练曲线
3. **最后删除**: 重要的模型检查点

### ⚠️ 注意事项

#### 删除操作不可撤销
```
❌ 删除的文件无法恢复
✅ 删除前请确认文件不再需要
✅ 重要检查点请先备份
```

#### 检查点文件很重要
```
🔴 删除检查点后：
   - 下次训练从头开始
   - 无法利用之前的训练成果
   - 训练时间会更长

💡 建议：
   - 保留最近的检查点
   - 删除旧版本模型
```

### 📝 实用场景

#### 场景1: 清理测试数据
```
情况: 进行了5次测试训练，想要清理所有测试数据

步骤:
1. 打开文件管理页面
2. 点击 "清空所有文件"
3. 确认删除
4. 完成！磁盘空间释放

结果: 删除约 30-40 个文件，释放 200-500 MB
```

#### 场景2: 只删除某次训练的文件
```
情况: 第3次训练效果不好，想删除该次训练的所有文件

步骤:
1. 在文件列表中找到该次训练的文件
   （文件名包含相同的 session_id 前缀）
2. 使用 API 批量删除：
   POST /api/delete_by_session
   { "session_id": "31401239..." }

结果: 删除该次训练的 7 个文件
```

#### 场景3: 只保留最新模型
```
情况: 有多个检查点，只想保留最新的

步骤:
1. 进入 "模型检查点" 区域
2. 查看文件的修改时间
3. 删除旧的检查点文件
4. 保留最新的 1-2 个

结果: 释放 100-200 MB 空间
```

### 🎓 进阶技巧

#### 技巧1: 通过文件名识别训练
```
文件名格式: comparison_{session_id}_{实例编号}.png

示例:
comparison_31401239_1.png  ← session_id: 31401239
comparison_31401239_2.png  ← 同一次训练
comparison_5cda19fb_1.png  ← session_id: 5cda19fb (不同训练)

技巧: 相同 session_id 前缀的文件来自同一次训练
```

#### 技巧2: 自动化批量删除
```python
# 删除所有GIF动画（占用空间最大）
import requests

response = requests.get('http://localhost:5000/api/list_files')
plots = response.json()['files']['plots']

for file in plots:
    if file['name'].endswith('.gif'):
        requests.post(
            'http://localhost:5000/api/delete_file',
            json={'filename': file['name'], 'file_type': 'plot'}
        )
        print(f"已删除: {file['name']}")
```

---

## 安全机制

### 1. 路径安全检查

**防止路径遍历攻击**

```python
# 确保文件在允许的目录内
abs_file_path = os.path.abspath(file_path)
abs_plots_dir = os.path.abspath(PLOTS_DIR)
abs_checkpoints_dir = os.path.abspath(CHECKPOINTS_DIR)

if not (abs_file_path.startswith(abs_plots_dir) or 
        abs_file_path.startswith(abs_checkpoints_dir)):
    return jsonify({'success': False, 'message': '无效的文件路径'}), 403
```

**防止**：
- 路径遍历攻击（`../../../etc/passwd`）
- 删除系统关键文件
- 访问未授权目录

### 2. 文件类型限制

- 只允许删除 `.png`、`.gif`、`.ckpt` 类型的文件
- 自动识别文件类型，防止误删

### 3. 操作确认机制

- **删除单个文件**: 前端弹窗确认
- **清空所有文件**: 需双重确认（前端 + 后端）

---

## 实现细节

### 文件命名规则

#### 可视化文件命名
```
comparison_{session_id前8位}_{实例编号}.png
animation_{session_id前8位}_{实例编号}.gif
training_curves_{session_id前8位}.png
```

**示例**:
```
comparison_31401239_1.png
comparison_31401239_2.png
comparison_31401239_3.png
animation_31401239_1.gif
animation_31401239_2.gif
animation_31401239_3.gif
training_curves_31401239.png
```

#### 检查点文件命名
```
{问题类型}-{模型类型}.ckpt
```

**示例**:
```
tsp-attention.ckpt
cvrp-attention.ckpt
```

### 代码集成

#### 后端路由 (app.py)
```python
@app.route('/file_manager')               # 文件管理页面
@app.route('/api/list_files')             # 列出所有文件
@app.route('/api/delete_file')            # 删除单个文件
@app.route('/api/delete_by_session')      # 批量删除（按会话）
@app.route('/api/clear_all_files')        # 清空所有文件
```

#### 前端页面 (templates/file_manager.html)
- 响应式卡片网格布局
- 实时统计信息面板
- 图片预览功能
- 交互式删除确认

#### 导航集成 (templates/index.html)
```html
<div class="nav-links">
    <a href="#home">首页</a>
    <a href="#config">训练模型</a>
    <a href="/benchmark">算法对比</a>
    <a href="/file_manager">文件管理</a>
    <a href="#about">关于项目</a>
</div>
```

### 磁盘空间管理

**单次训练产生的文件**
```
- 对比图: 3 张 × 0.3 MB = 0.9 MB
- 动画: 3 个 × 2 MB = 6 MB
- 训练曲线: 1 张 × 0.3 MB = 0.3 MB
- 检查点: 1 个 × 70 MB = 70 MB
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
总计: ~77 MB / 次训练
```

**磁盘空间预估**
- 10 次训练 ≈ 770 MB
- 50 次训练 ≈ 3.8 GB
- 100 次训练 ≈ 7.7 GB

**建议**: 每周清理一次旧文件

---

## 故障排查

### 问题1: 文件列表显示为空

**解决方案**:
1. 确认是否进行过训练（训练会生成文件）
2. 检查 `static/model_plots/` 和 `checkpoints/` 目录是否存在
3. 点击 "刷新列表" 按钮
4. 查看浏览器控制台是否有错误

### 问题2: 删除文件失败

**可能原因**:
- 文件被其他程序占用（关闭图片查看器）
- 文件权限不足（检查文件权限）
- 文件不存在（可能已被删除）

**解决方案**:
```bash
# Windows: 检查文件是否被占用
handle.exe static/model_plots/xxx.png

# Linux: 检查文件权限
ls -la static/model_plots/
chmod 644 static/model_plots/*.png
```

### 问题3: 清空按钮无响应

**解决方案**:
1. 打开浏览器开发者工具（F12）
2. 查看 Console 是否有错误信息
3. 确认后端服务正常运行
4. 刷新页面重试

### 问题4: API 调用失败

**检查清单**:
- ✅ 服务器是否正在运行
- ✅ 请求URL是否正确
- ✅ Content-Type头是否正确
- ✅ 请求体格式是否正确
- ✅ 查看服务器日志

---

## 常见问题

### Q1: 删除文件后还能恢复吗？
**A**: 不能。删除操作是永久性的，无法恢复。请确保删除前已备份重要文件。

### Q2: 为什么删除检查点后训练速度变慢？
**A**: 检查点文件用于断点续训。删除后，下次训练将从头开始，无法利用之前的训练成果。

### Q3: 可以批量选择删除吗？
**A**: 当前版本支持：
- ✅ 根据 session_id 批量删除
- ✅ 清空所有文件
- ❌ 自定义多选（可作为未来功能）

### Q4: 文件占用空间过大怎么办？
**A**: 
1. 优先删除 `.gif` 动画文件（占用最大）
2. 只保留最近的训练检查点
3. 使用 "清空所有文件" 重置

---

## 更新日志

### v1.0.0 (2024)
- ✨ 初始版本发布
- ✅ 文件列表展示
- ✅ 单个文件删除
- ✅ 批量删除功能
- ✅ 文件统计信息
- ✅ 图片预览功能
- ✅ 安全检查机制
- ✅ 响应式界面设计

---

## 未来功能规划

- [ ] 文件下载功能
- [ ] 文件压缩打包
- [ ] 自定义多选删除
- [ ] 文件搜索过滤
- [ ] 自动清理策略配置
- [ ] 文件使用分析报告
- [ ] 检查点比较功能
- [ ] 操作历史记录
- [ ] 云存储集成

---

## 技术支持

如有问题或建议，欢迎通过以下方式联系：

- 📧 提交Issue到项目仓库
- 📖 查看完整文档
- 💬 联系开发团队

---

**文档版本**: v1.0.0  
**最后更新**: 2024年  
**平台**: RL4CO 强化学习优化平台  
**单位**: 山西大学 计算机科学与技术学院

